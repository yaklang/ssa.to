<!doctype html>
<html lang="zh" dir="ltr" class="docs-wrapper plugin-docs plugin-id-static-analysis-guide docs-version-current docs-doc-page docs-doc-id-ssa-for-advanced-language-2" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.6.1">
<title data-rh="true">第三章：高级语言的 SSA 构建（二） | SSA.to</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://ssa.to/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://ssa.to/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://ssa.to/static-analysis-guide/ssa-for-advanced-language-2"><meta data-rh="true" property="og:locale" content="zh"><meta data-rh="true" property="og:locale:alternate" content="en"><meta data-rh="true" name="docusaurus_locale" content="zh"><meta data-rh="true" name="docsearch:language" content="zh"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-static-analysis-guide-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-static-analysis-guide-current"><meta data-rh="true" property="og:title" content="第三章：高级语言的 SSA 构建（二） | SSA.to"><meta data-rh="true" name="description" content="在《第三章：高级语言的 SSA 构建（一）》中，我们讨论了 SSA 的基本概念和基本编译技术，并且详细分析和讨论了分支的 SSA 构建，接下来，我们将会继续未竟的话题，讨论循环的 SSA 构建和函数构建。"><meta data-rh="true" property="og:description" content="在《第三章：高级语言的 SSA 构建（一）》中，我们讨论了 SSA 的基本概念和基本编译技术，并且详细分析和讨论了分支的 SSA 构建，接下来，我们将会继续未竟的话题，讨论循环的 SSA 构建和函数构建。"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://ssa.to/static-analysis-guide/ssa-for-advanced-language-2"><link data-rh="true" rel="alternate" href="https://ssa.to/static-analysis-guide/ssa-for-advanced-language-2" hreflang="zh"><link data-rh="true" rel="alternate" href="https://ssa.to/en/static-analysis-guide/ssa-for-advanced-language-2" hreflang="en"><link data-rh="true" rel="alternate" href="https://ssa.to/static-analysis-guide/ssa-for-advanced-language-2" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.b1561eee.css">
<script src="/assets/js/runtime~main.a69ec885.js" defer="defer"></script>
<script src="/assets/js/main.9df25ad8.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo-dark.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">SSA.to</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/static-analysis-guide/intro">静态代码分析教程</a><a class="navbar__item navbar__link" href="/docs/intro">代码扫描基础使用</a><a class="navbar__item navbar__link" href="/syntaxflow-guide/intro">SyntaxFlow 文档</a><a class="navbar__item navbar__link" href="/cookbook">SyntaxFlow 手册离线 PDF</a><a class="navbar__item navbar__link" href="/codeAnalysis">Code Analysis NOW!</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/yaklang/ssa.to" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>中文</a><ul class="dropdown__menu"><li><a href="/static-analysis-guide/ssa-for-advanced-language-2" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh">中文</a></li><li><a href="/en/static-analysis-guide/ssa-for-advanced-language-2" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en">English</a></li></ul></div><div class="navbarSearchContainer_dCNk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_eExm"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/static-analysis-guide/intro">第一章：编译与静态代码分析概论</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/static-analysis-guide/compile-ssa-form">第二章：详解静态单赋值形式</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/static-analysis-guide/ssa-for-advanced-language">第三章：高级语言的 SSA 构建（一）</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/static-analysis-guide/ssa-for-advanced-language-2">第三章：高级语言的 SSA 构建（二）</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/static-analysis-guide/deep-dive-into-ssa-closure">第四章：SSA 深水区 - 闭包函数</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/static-analysis-guide/deep-dive-into-ssa-oop">第五章：SSA 深水区 - OOP与无类</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/static-analysis-guide/deep-dive-into-ssa-use-def-chain">第六章：SSA 深水区 - 数据流分析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/static-analysis-guide/deep-dive-into-ssa-cross-procedure">第七章：SSA 深水区 - 跨过程分析</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">第三章：高级语言的 SSA 构建（二）</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>第三章：高级语言的 SSA 构建（二）</h1></header>
<p>在《第三章：高级语言的 SSA 构建（一）》中，我们讨论了 SSA 的基本概念和基本编译技术，并且详细分析和讨论了分支的 SSA 构建，接下来，我们将会继续未竟的话题，讨论循环的 SSA 构建和函数构建。</p>
<hr>
<!-- -->
<div class="tableOfContentsInline_prmo"><ul class="table-of-contents"><li><a href="#ssa-构建流程控制循环">SSA 构建流程控制：循环</a><ul><li><a href="#规约循环与非规约循环">规约循环与非规约循环</a></li><li><a href="#三段式循环">三段式循环</a></li><li><a href="#三段式循环的基本块分析">三段式循环的基本块分析</a></li><li><a href="#循环中的-phi-生成">循环中的 Phi 生成</a></li><li><a href="#三段式循环中的-phi-生成形式化表示">三段式循环中的 Phi 生成形式化表示</a></li><li><a href="#举一反三for-each-与迭代器">举一反三：For-Each 与迭代器</a></li></ul></li><li><a href="#ssa-构建函数概念与算法">SSA 构建函数概念与算法</a><ul><li><a href="#函数的基本概念">函数的基本概念</a></li><li><a href="#通用函数形式化">通用函数形式化</a></li><li><a href="#从-ast-到-ssa-识别和创建函数">从 AST 到 SSA 识别和创建函数</a></li></ul></li></ul></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ssa-构建流程控制循环">SSA 构建流程控制：循环<a href="#ssa-构建流程控制循环" class="hash-link" aria-label="SSA 构建流程控制：循环的直接链接" title="SSA 构建流程控制：循环的直接链接">​</a></h2>
<p>在开始了解 SSA 构建循环之前，我们需要先了解循环本身的基本概念：</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="规约循环与非规约循环">规约循环与非规约循环<a href="#规约循环与非规约循环" class="hash-link" aria-label="规约循环与非规约循环的直接链接" title="规约循环与非规约循环的直接链接">​</a></h3>
<p>规约循环（Reducible Loop）：规约循环是一个非常好的循环，他的特点是：</p>
<ol>
<li>入口唯一</li>
<li>所有回边都指向入口（循环头）</li>
<li>循环头支配所有循环体的节点</li>
</ol>
<!-- -->
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>提示</div><div class="admonitionContent_BuS1"><p>规约循环是最常见的循环形式，大多数高级语言不使用 Goto 构成的循环结构（如 for、while）都会生成规约循环。</p></div></div>
<p>与之相对的概念是非规约循环（Irreducible Loop），非规约循环的特点是：</p>
<ol>
<li>入口点可能有多个；</li>
<li>回边可以指向循环内任意节点；</li>
<li>循环头有可能无法支配所有循环体节点；</li>
</ol>
<p>我们可以举出很多个非规约循环的案例：</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="多入口循环">多入口循环<a href="#多入口循环" class="hash-link" aria-label="多入口循环的直接链接" title="多入口循环的直接链接">​</a></h4>
<!-- -->
<p>这个循环是非规约的，原因在于：</p>
<ol>
<li>存在两个入口点（Entry 1 和 Entry 2）可以进入循环</li>
<li>循环没有唯一的循环头（B 和 D 都可以作为入口点）</li>
<li>既不是 B 支配 D，也不是 D 支配 B</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="交叉循环">交叉循环<a href="#交叉循环" class="hash-link" aria-label="交叉循环的直接链接" title="交叉循环的直接链接">​</a></h4>
<!-- -->
<p>这个例子展示了两个相互交叉的循环：</p>
<ol>
<li>B-C-D 形成一个循环</li>
<li>C-E 形成另一个循环</li>
<li>循环 C-E 和循环 B-C-D 共享节点 C</li>
<li>没有唯一的循环头，因为 C 既属于一个循环又属于另一个循环</li>
</ol>
<div class="theme-admonition theme-admonition-danger admonition_xJq3 alert alert--danger"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>危险</div><div class="admonitionContent_BuS1"><p>我们现在讨论的循环，都是规约循环。</p><p>在后面的内容，会尽量少的讨论非规约循环，因为非规约循环的构建一般需要用到一些 GOTO 之类的控制指令，或者在更低级语言中无条件跳转，过早地接触这些内容会让读者心生恐惧。</p><p>非规约循环的处理一般会想办法转移到现有的规约循环中，或者直接使用 GOTO + Label 来组合，优化也会变得更加复杂。</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="三段式循环">三段式循  环<a href="#三段式循环" class="hash-link" aria-label="三段式循环的直接链接" title="三段式循环的直接链接">​</a></h3>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>提示</div><div class="admonitionContent_BuS1"><p>三段式循环(Three-Address Loop)是一种常见的循环结构模式，我们在这里深入讨论这种经典的循环结构的 SSA 构建。</p><p>在读者阅读本节之后，可以尝试阅读 <a href="https://llvm.org/docs/LangRef.html#three-address-loops" target="_blank" rel="noopener noreferrer">LLVM 的 SSA 构建文档</a> 以获得更多信息。</p><p>也可以深入思考对于其他的循环结构应该如何构建 SSA。</p></div></div>
<p>C 语言风格的循环一般由三部分组成：初始化、循环体、更新。 考虑如下代码：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package main;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class Main {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		for (int i = 0; i &lt; 10; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			System.out.println(&quot;Hello, World!&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>上述代码编译后核心 SSA 结构如下：</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token generic-function function" style="color:#d73a49">Main_main_e5a8</span><span class="token generic-function"> </span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name builtin">string</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">11</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> args</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">entry</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	jump </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> loop</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">header</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">loop</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">header</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> entry</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	jump </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> loop</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">condition</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">loop</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">condition</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">2</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> loop</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">header</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> loop</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">latch</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">any</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> t33 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> phi </span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">number</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> loop</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">header</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">number</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> t31</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> loop</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">latch</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">boolean</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> t19 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">any</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> t33 lt </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">number</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Loop </span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">nil</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">boolean</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> t19</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">nil</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> body </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> loop</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">body</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exit </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> loop</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">exit</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">loop</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">body</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">3</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> loop</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">condition</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">#</span><span class="token number" style="color:#36acaa">24</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">println</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> t26 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">undefined</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">from</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">24</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">any</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> t24 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">undefined</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">out</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">valid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">from</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">22</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">any</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> t22 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">undefined</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">System</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">null</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> t28 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> call </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">#</span><span class="token number" style="color:#36acaa">24</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">println</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">t26</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">any</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> t24</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> Hello</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> World</span><span class="token operator" style="color:#393A34">!</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> binding</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> member</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	jump </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> loop</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">latch</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">loop</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">latch</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">4</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> loop</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">body</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">number</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> t31 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">any</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> t33 add </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">number</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	jump </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> loop</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">condition</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">loop</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">exit</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">5</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> loop</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">condition</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">extern type</span><span class="token operator" style="color:#393A34">:</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="三段式循环的基本块分析">三段式循环的基本块分析<a href="#三段式循环的基本块分析" class="hash-link" aria-label="三段式循环的基本块分析的直接链接" title="三段式循环的基本块分析的直接链接">​</a></h3>
<p>在这个例子中，循环被分解为以下几个基本块：</p>
<ol>
<li><code>entry-0</code>: 程序入口块</li>
<li><code>loop.header-1</code>: 循环头部块</li>
<li><code>loop.condition-2</code>: 循环条件判断块</li>
<li><code>loop.body-3</code>: 循环体块</li>
<li><code>loop.latch-4</code>: 循环更新块</li>
<li><code>loop.exit-5</code>: 循环出口块</li>
</ol>
<p>让我们用 mermaid 来可视化这个控制流图：</p>
<!-- -->
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="循环中的-phi-生成">循环中的 Phi 生成<a href="#循环中的-phi-生成" class="hash-link" aria-label="循环中的 Phi 生成的直接链接" title="循环中的 Phi 生成的直接链接">​</a></h3>
<p>根据我们在 &quot;第二章&quot; 中基本块和 Phi 生成的讨论，我们知道 Phi 节点是用来处理多入口基本块的。我们在这里发现，<code>loop</code> 的 <code>loop.condition-2</code> 中包含了两个前驱块，所以这儿可能会生成 Phi。</p>
<p>那么，我们把上述图再细化一下，得到如下内容：</p>
<!-- -->
<p>我们会得到一个 phi 节点 <code>t33</code>，这个 phi 节点会根据前驱块的不同，选择不同的值。可能的选项为：</p>
<ol>
<li>如果前驱块是 <code>loop.header-1</code>，则 <code>t33</code> 的值为 0</li>
<li>如果前驱块是 <code>loop.latch-4</code>，则 <code>t33</code> 的值为 <code>t31</code></li>
</ol>
<p>这个情况是一个典型的 For 循环中的 Phi 节点生成的案例。</p>
<p>仔细观察一下，我们发现 t33 依赖（被支配）了 t31，而 t31 又是由 <code>t33 + 1</code> 得到的（支配），这陷入了一个循环。我们把这个关系表述成一个更精炼的图</p>
<!-- -->
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>提示</div><div class="admonitionContent_BuS1"><p>虽然从 “空间” 上看，这是一个不健康的支配依赖，但是在 SSA 中，这是完全合法的：</p><ol>
<li>时序关系：<code>t33</code> 在 <code>t31</code> 之前被定义，每次都是先使用 t33 的值，才需要计算新的 t31.</li>
<li>Phi 节点在过程中选择不同路径，导致不同的值，这是执行的时候控制的，并不需要我们来解决。</li>
</ol></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>额外读物：停机问题 与 图灵完备</div><div class="admonitionContent_BuS1"><p>图灵完备（Turing Complete）指的是一个计算系统能够模拟通用图灵机的计算能力，换句话说，它能够计算任何可计算的函数。一个系统要达到图灵完备，需要具备基本的控制流（如条件判断和循环）以及任意数量的存储空间。现代的编程语言，包括我们的 SSA 中间表示，都是图灵完备的。</p><p>停机问题（Halting Problem）是指：给定一个程序和它的输入，判断这个程序是否会在有限时间内终止运行。这个看似简单的问题，实际上是不可判定的。换句话说，不存在一个通用的算法能够准确判断任意程序是否会停机。</p></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>为什么图灵完备系统无法证明停机问题？</div><div class="admonitionContent_BuS1"><p>这是因为存在一个根本性的矛盾：</p><ol>
<li>假设存在一个函数 <code>willHalt(program, input)</code>，它能判断任意程序是否会停机</li>
<li>我们可以构造一个新程序 <code>paradox()</code>：<!-- -->
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">paradox</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> willHalt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">paradox</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 如果 paradox 会停机</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">pass</span><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 就进入死循环</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">                      </span><span class="token comment" style="color:#999988;font-style:italic"># 如果 paradox 不会停机</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain">                 </span><span class="token comment" style="color:#999988;font-style:italic"># 就立即返回</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>这会导致逻辑矛盾：<!-- -->
<ul>
<li>如果 <code>willHalt</code> 判断 <code>paradox</code> 会停机，那么 <code>paradox</code> 就会进入死循环（不停机）</li>
<li>如果 <code>willHalt</code> 判断 <code>paradox</code> 不会停机，那么 <code>paradox</code> 就会立即返回（停机）</li>
</ul>
</li>
</ol><p>这个矛盾证明了不可能存在这样的 <code>willHalt</code> 函数。</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="三段式循环中的-phi-生成形式化表示">三段式循环中的 Phi 生成形式化表示<a href="#三段式循环中的-phi-生成形式化表示" class="hash-link" aria-label="三段式循环中的 Phi 生成形式化表示的直接链接" title="三段式循环中的 Phi 生成形式化表示的直接链接">​</a></h3>
<p>让我们用形式化的方式来表示三段式循环中的 Phi 生成 。</p>
<p>三段式循环的基本结构中，分为三个基本部分：</p>
<ol>
<li><strong>初始化</strong> (Init)：循环开始前的准备工作</li>
<li><strong>条件判断</strong> (Cond)：循环继续的条件检查</li>
<li><strong>更新</strong> (Update)：每次迭代后的状态更新</li>
</ol>
<p>让我们用形式化的方式来表示：</p>
<!-- -->
<p>对于循环中的变量，我们可以用以下形式化表示：</p>
<div class="katex-container block" style="display:block"></div>
<p>形式化的 Phi 节点生成规则：</p>
<ol>
<li><strong>入口 Phi 规则</strong>：</li>
</ol>
<div class="katex-container block" style="display:block"></div>
<ol start="2">
<li><strong>循环变量集合定义</strong>：</li>
</ol>
<div class="katex-container block" style="display:block"></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="phi-节点的生成条件">Phi 节点的生成条件<a href="#phi-节点的生成条件" class="hash-link" aria-label="Phi 节点的生成条件的直接链接" title="Phi 节点的生成条件的直接链接">​</a></h4>
<p>一个变量 v 需要在循环头部生成 Phi 节点，当且仅当：</p>
<ol>
<li>v 在循环中被修改</li>
<li>v 在循环中被使用</li>
<li>v 的定义到达循环头部的路径不止一条</li>
</ol>
<p>例如，对于以下代码：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sum </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sum </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>虽然上述代码并不是一个典型的三段式循环，但是我们可以用类似三段式循环的结构来分析它。</p>
<p>其 SSA 形式为：</p>
<!-- -->
<p>形式化的变量依赖关系：</p>
<div class="katex-container block" style="display:block"></div>
<div class="theme-admonition theme-admonition-danger admonition_xJq3 alert alert--danger"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>注意 易错问题与误区</div><div class="admonitionContent_BuS1"><p>在生成 Phi 节点时，需要注意：</p><ol>
<li>不是所有循环变量都需要 Phi 节点</li>
<li>Phi 节点的操作数顺序必须与控制流图中的前驱块顺序一致</li>
<li>需要考虑循环嵌套时的变量版本关系</li>
</ol></div></div>
<p>我们把上述所有内容和易错事项总结成 Phi 生成的公式（算法）如下：</p>
<div class="katex-container block" style="display:block"></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="举一反三for-each-与迭代器">举一反三：For-Each 与迭代器<a href="#举一反三for-each-与迭代器" class="hash-link" aria-label="举一反三：For-Each 与迭代器的直接链接" title="举一反三：For-Each 与迭代器的直接链接">​</a></h3>
<p>在实际生产中，三段式循环的结构和 For-Each 循环结构在编程中都非常常见。如果想要 For-Each 的循环结构推广到三段式循环中，则需要引入迭代器这一个概念：</p>
<p>一般我们认为迭代器的核心接口有两个:</p>
<ol>
<li><code>hasNext()</code>: 判断是否还有下一个元素</li>
<li><code>next()</code>: 获取下一个元素</li>
</ol>
<p>在不同语言中，迭代器的实现方式不尽相同，但是其核心思想是相同的。</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>迭代器的本质与形式化定义</div><div class="admonitionContent_BuS1"><p>迭代器是一种设计模式，它提供了一种统一的方式来访问集合中的元素，而无需暴露集合的内部结构。</p><p><strong>核心接口定义(Java 版)：</strong></p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">interface Iterator&lt;T&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean hasNext();  // 判断是否还有下一个元素</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    T next();          // 获取下一个元素</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>形式化定义：</strong></p><div class="katex-container block" style="display:block"></div><p><strong>基本性质：</strong></p><ul>
<li>如果 hasNext() = false，则 next() = ⊥（表示未定义）</li>
<li>每次调用 next() 都会改变迭代器状态</li>
<li>迭代器提供了一个单向遍历序列的抽象</li>
</ul></div></div>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">for (Element e : collection) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 使用元素 e</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    process(e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>假定我们使用迭代器来遍历列表，则上述代码的 SSA 形式为：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">for (Iterator&lt;Element&gt; iter = collection.iterator(); // 初始化部分</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     iter.hasNext();                                 // 条件判断部分</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     /* 空的更新部分 */) {                             // 更新部分</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Element e = iter.next();                         // 循环体</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    process(e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我们把上述代码编程迭代器的格式之后，就会得到下面的基本块 CFG 来表示：</p>
<!-- -->
<p>我们在之前的内容中，已经详细讨论了关于这种三段式循环的 Phi 生成问题和应该怎么处理，在此就不需要额外讲了，读者可以自由发挥。</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ssa-构建函数概念与算法">SSA 构建函数概念与算法<a href="#ssa-构建函数概念与算法" class="hash-link" aria-label="SSA 构建函数概念与算法的直接链接" title="SSA 构建函数概念与算法的直接链接">​</a></h2>
<p>在上述内容中，我们已经基本上完成了一个过程内的 SSA 构建基本研究方法，接下来我们将要简单讲述一下一个函数实体如何构建。当然首先，我们需要解释一下“函数”这个概念本身。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="函数的基本概念">函数的基本概念<a href="#函数的基本概念" class="hash-link" aria-label="函数的基本概念的直接链接" title="函数的基本概念的直接链接">​</a></h3>
<p>在编程中，<strong>函数</strong>是一个组织代码的基本单元，它将一组相关的代码片段封装在一起，使其可以被重复调用和执行。函数的目的是提高代码的<strong>可重用性</strong>、<strong>可读性</strong>和<strong>模块化</strong>，从而让程序更加清晰和易于维护。</p>
<ol>
<li><strong>输入（参数）</strong>：函数可以接收外部传入的值（称为参数），这些值可以用来在函数内部进行计算或操作。</li>
<li><strong>输出（返回值）</strong>：函数通常会返回一个结果  （也可以没有返回值），这个结果可以被程序的其他部分使用。</li>
<li><strong>封装</strong>：函数将一组代码逻辑封装在一起，用户只需要知道函数的功能，而不需要关心其内部实现细节。</li>
<li><strong>可重用性</strong>：函数定义好后，可以在程序中多次调用，不需要重复编写相同的代码。</li>
</ol>
<p>作为一个编译级的项目和教程内容，仅仅了解函数的上述内容是远远不够的，我们还需要了解函数中具体有什么：</p>
<ol>
<li><strong>函数元信息</strong>：函数名、参数、返回值</li>
<li><strong>函数控制流图</strong>：函数内部的代码结构，包括基本块、边、入口和出口</li>
<li><strong>代码（SSA 形式）</strong>：函数内部的 SSA 形式，包括 Phi 节点、定义、使用</li>
<li><strong>闭包</strong>：函数内部捕获的外部变量</li>
<li><strong>副作用</strong>：函数内部产生的副作用，例如修改某个外部变量</li>
</ol>
<p>虽然在很多函数或者编程的具体过程中，我们是不感知闭包和副作用的（也有例外，在 PHP 中捕获变量需要显式声明），但是想要深度理解现代编程语言中的函数，理解闭包和副作用是不可或缺的一步。</p>
<p>所以假如我们要设计一个指令专门用来保存函数，那这个指令的结构体设计能长什么样呢？</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">SSA_Function</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    opcode</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;function&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    meta</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        params</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        returns</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cfg</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        blocks</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Block</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        edges</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Edge</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        entry</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Block</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        exit</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Block</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ssa</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        phi</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Phi</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        definitions</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Definition</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        uses</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Use</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    closure</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Variable</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sideEffects</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Variable</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>他的 UML 类图如下：</p>
<!-- -->
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>注意：</div><div class="admonitionContent_BuS1"><p>我们尽可能把函数当成一个结构体设计，但是他也需要具备所有的指令的特性。这是为了方便 <strong>一等公民</strong> 的特性。</p><p>在编程语言中，<strong>一等公民</strong>（First-class Citizen）是指一个实体可以：</p><ol>
<li>作为函数的参数传递</li>
<li>作为函数的返回值</li>
<li>赋值给变量</li>
<li>存储在数据结构中</li>
</ol><p>当函数是一等公民时，它就像普通的值（如整数、字符串）一样，可以被自由地操作和传递。这种特性使得函数式编程成为可能，并增强了代码的灵活性和表达能力。</p></div></div>
<p>根据上述的结构体设计，我们可以得到一个函数的形式化定义：</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="通用函数形式化">通用函数形式化<a href="#通用函数形式化" class="hash-link" aria-label="通用函数形式化的直接链接" title="通用函数形式化的直接链接">​</a></h3>
<p>我们在 SSA 编译器视角下，认为函数是程序执行的基本单元。</p>
<p>在 SSA 的上下文中，函数（Function）是一个自包含的程序执行单元，可以形式化定义为：</p>
<div class="katex-container block" style="display:block"></div>
<p>上述定义的函数具有如下性质：</p>
<div class="katex-container block" style="display:block"></div>
<div class="katex-container block" style="display:block"></div>
<p>这个函数和我们在常见编程语言中的“函数”有相同点，也有不同点。我们在这里定义的函数相对来说更加“通用”，因为我们目的是“通用编译”，而不是“特定语言”。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="从-ast-到-ssa-识别和创建函数">从 AST 到 SSA 识别和创建函数<a href="#从-ast-到-ssa-识别和创建函数" class="hash-link" aria-label="从 AST 到 SSA 识别和创建函数的直接链接" title="从 AST 到 SSA 识别和创建函数的直接链接">​</a></h3>
<p>我们在讨论一个函数创建的时候，假定我们已经有一个函数内的编译过程了，由于函数是一等公民，它可以是任何 SSA 变量，那么这个编译过程一定是递归的。</p>
<p>所以我们使用一个流程图来表示函数的编译过程（递归使用循环流程表示）</p>
<!-- -->
<p>我们把上述结构编写一段伪代码如下：</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">compileAST</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ast</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Node</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> CompileContext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> SSAResult </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 当前节点是函数声明</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">isFunctionDeclaration</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ast</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 创建函数上下文和SSA Function</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> functionContext </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">CompileContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> ssaFunction </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">SSA_Function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            meta</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">extractFunctionMeta</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ast</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            context</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> functionContext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 递归编译函数体</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> bodyResult </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">compileAST</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ast</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">body</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> functionContext</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ssaFunction</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">merge</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bodyResult</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 注册为SSA变量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">registerFunction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ssaFunction</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 普通节点编译</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">compileNormalNode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ast</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>形式化表达如下：</p>
<div class="katex-container block" style="display:block"></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>提示</div><div class="admonitionContent_BuS1"><p>这个算法描述采用了标准的伪代码格式，其中：</p><ul>
<li>使用 <div class="katex-container inline" style="display:inline-block"></div> 表示赋值操作</li>
<li>使用缩进表示代码块层级</li>
<li>清晰地标注了输入和输出</li>
<li>使用 <div class="katex-container inline" style="display:inline-block"></div> 标注关键字</li>
</ul></div></div>
<p>这个算法可以形式化地表达为如下的数学定义：</p>
<div class="katex-container block" style="display:block"></div>
<p>其中：</p>
<div class="katex-container block" style="display:block"></div>
<p>这里：</p>
<ul>
<li><div class="katex-container inline" style="display:inline-block"></div> 表示新创建的函数上下文</li>
<li><div class="katex-container inline" style="display:inline-block"></div> 表示 merge 操作</li>
<li><div class="katex-container inline" style="display:inline-block"></div> 是从节点提取的函数元信息</li>
</ul>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>提示</div><div class="admonitionContent_BuS1"><p>在这个形式化表达中，我们使用了分段函数的形式来表示条件分支，这样可以更简洁地表达算法的核心逻辑。</p><div class="katex-container inline" style="display:inline-block"></div> 操作符表示将编译结果合并到 SSA Function 中的过程。<p></p></div></div>
<p>在了解完上述内容之后，我们就可以开始讨论函数内部的编译过程以及如何处理函数中的一些麻烦事儿了，在接下来的过程中，我们将潜入 SSA 深水区，讨论在函数的体系下各种精巧的内部结构如何编译。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/yaklang/ssa.to/tree/main/static-analysis-guide/static-analysis-guide/ssa-for-advanced-language-2.mdx" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">最后<!-- -->由 <b>VillanCh</b> <!-- -->于 <b><time datetime="2024-12-01T04:53:36.000Z" itemprop="dateModified">2024年12月1日</time></b> <!-- -->更新</span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/static-analysis-guide/ssa-for-advanced-language"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">第三章：高级语言的 SSA 构建（一）</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/static-analysis-guide/deep-dive-into-ssa-closure"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">第四章：SSA 深水区 - 闭包函数</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#ssa-构建流程控制循环" class="table-of-contents__link toc-highlight">SSA 构建流程控制：循环</a><ul><li><a href="#规约循环与非规约循环" class="table-of-contents__link toc-highlight">规约循环与非规约循环</a></li><li><a href="#三段式循环" class="table-of-contents__link toc-highlight">三段式循环</a></li><li><a href="#三段式循环的基本块分析" class="table-of-contents__link toc-highlight">三段式循环的基本块分析</a></li><li><a href="#循环中的-phi-生成" class="table-of-contents__link toc-highlight">循环中的 Phi 生成</a></li><li><a href="#三段式循环中的-phi-生成形式化表示" class="table-of-contents__link toc-highlight">三段式循环中的 Phi 生成形式化表示</a></li><li><a href="#举一反三for-each-与迭代器" class="table-of-contents__link toc-highlight">举一反三：For-Each 与迭代器</a></li></ul></li><li><a href="#ssa-构建函数概念与算法" class="table-of-contents__link toc-highlight">SSA 构建函数概念与算法</a><ul><li><a href="#函数的基本概念" class="table-of-contents__link toc-highlight">函数的基本概念</a></li><li><a href="#通用函数形式化" class="table-of-contents__link toc-highlight">通用函数形式化</a></li><li><a href="#从-ast-到-ssa-识别和创建函数" class="table-of-contents__link toc-highlight">从 AST 到 SSA 识别和创建函数</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer_jryj"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/community#%E5%BE%AE%E4%BF%A1%E4%BA%A4%E6%B5%81%E7%BE%A4">Wechat</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/yaklang/ssa.to" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"></div></div><div class="footer__copyright copyright_C_OK">Copyright © 2024 ssa.to, Powered by yaklang.io</div></footer></div>
</body>
</html>